<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greeting Card Editor</title>
    
    <!-- 아이콘 라이브러리 (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 폰트 (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Great+Vibes&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* * 1. 전역 스타일 및 변수 설정 */
        :root {
            --color-bg: #FFFCF9;
            --color-card-bg: #FFFDF5;
            --color-primary: #F29D86;
            --color-primary-dark: #E88A75;
            --color-ribbon: #D6B5A1;
            --color-text-main: #222222;
            --color-text-script: #1A1A1A;
            --color-shadow: rgba(0, 0, 0, 0.08);
            
            --font-main: 'Roboto', sans-serif;
            --font-script: 'Great Vibes', cursive;
            --font-hand: 'Caveat', cursive;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text-main);
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100%;
            background-color: var(--color-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .px-20 { padding-left: 20px; padding-right: 20px; }

        /* * 헤더 */
        .top-bar {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background-color: var(--color-bg);
            z-index: 10;
            flex-shrink: 0;
        }
        .btn-icon { background: none; border: none; cursor: pointer; padding: 8px; color: var(--color-text-main); display: flex; align-items: center; justify-content: center; }
        .top-bar h1 { font-size: 16px; font-weight: 700; color: var(--color-text-main); }
        .header-actions { display: flex; gap: 5px; }

        /* * 카드 미리보기 영역 */
        .card-preview {
            padding-top: 20px;
            padding-bottom: 20px;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
        }

        .card-paper {
            width: 100%;
            aspect-ratio: 4/5;
            background: linear-gradient(to bottom, #ffffff 60%, #fff0ea 100%);
            border-radius: 8px;
            box-shadow: 0 10px 25px var(--color-shadow);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-img {
            width: 100%;
            height: 55%;
            object-fit: cover;
            transition: opacity 0.2s ease-in-out;
        }

        .card-text {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px 40px 20px;
            width: 100%;
            overflow: hidden;
        }

        .card-text div {
            width: 100%;
            font-family: var(--font-script);
            font-size: 32px;
            line-height: 1.4;
            color: var(--color-text-script);
            word-break: break-word;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .card-text font[size="1"] { font-size: 16px !important; }
        .card-text font[size="2"] { font-size: 20px !important; }
        .card-text font[size="3"] { font-size: 24px !important; }
        .card-text font[size="4"] { font-size: 32px !important; }
        .card-text font[size="5"] { font-size: 40px !important; }
        .card-text font[size="6"] { font-size: 48px !important; }
        .card-text font[size="7"] { font-size: 60px !important; }

        .card-ribbon {
            position: absolute;
            bottom: 20px;
            background-color: var(--color-ribbon);
            padding: 4px 16px;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-ribbon span {
            font-family: var(--font-main);
            font-size: 10px;
            color: white;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 500;
        }

        /* * 썸네일 캐러셀 */
        .template-selector {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            margin-bottom: 40px; 
            padding-bottom: 10px;
            flex-shrink: 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
            cursor: grab;
            user-select: none;
            min-height: 100px;
            padding-left: 20px;
            padding-right: 20px;
        }
        .template-selector.active { cursor: grabbing; }
        .template-selector::-webkit-scrollbar { display: none; }

        .thumb-item {
            flex: 0 0 auto;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .thumb-item img {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 6px;
            padding: 3px;
            background: white;
            transition: all 0.2s;
            pointer-events: none;
        }
        .thumb-item span { font-size: 11px; color: #888; font-weight: 500; }
        .thumb-item.active img { border-color: var(--color-primary); transform: scale(1.05); }
        .thumb-item.active span { color: var(--color-primary); }

        .upload-placeholder {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            background: #fff;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            margin-bottom: 6px;
        }
        .thumb-item:hover .upload-placeholder { border-color: var(--color-primary); color: var(--color-primary); }

        /* * 툴바 영역 (드래그 스크롤 적용) */
        .style-toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            flex-shrink: 0;
            padding-left: 20px;
            padding-right: 20px;
            width: 100%;
            cursor: grab; /* 드래그 가능 커서 */
            user-select: none;
        }
        .style-toolbar.active { cursor: grabbing; }
        .style-toolbar::-webkit-scrollbar { display: none; }

        .style-select {
            padding: 0 8px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            font-size: 12px;
            color: #444;
            outline: none;
            font-family: var(--font-main);
            cursor: pointer;
            height: 36px;
            flex-shrink: 0; /* 줄어듦 방지 */
        }

        .toolbar-divider { width: 1px; height: 24px; background: #eee; margin: 0 2px; flex-shrink: 0; }

        .btn-style {
            width: 36px;
            height: 36px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0; /* 줄어듦 방지 */
        }
        .btn-style:hover { background: #f5f5f5; }
        .btn-style.active { background: #eef2ff; border-color: var(--color-primary); color: var(--color-primary); }

        /* 색상 변경 패널 */
        .color-panel {
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            background: white;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: absolute;
            bottom: 140px;
            left: 20px;
            right: 20px;
            z-index: 50;
        }
        .color-panel.show { display: flex; }
        .color-preview { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd; }

        .btn-confirm {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
        }

        .ribbon-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 5px;
            font-family: var(--font-main);
            flex-shrink: 0;
        }

        /* * 에디터 영역 */
        .message-input {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px;
            min-height: 200px;
        }

        .notepad-container {
            background-color: var(--color-card-bg);
            border-radius: 2px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-top: 5px;
        }
        .notepad-top {
            height: 15px;
            width: 100%;
            background-color: var(--color-card-bg);
            --mask: radial-gradient(10px at 50% 13px, #0000 98%, #000) 50% / 20px 100%;
            -webkit-mask: var(--mask);
            mask: var(--mask);
            margin-top: -10px;
        }
        .notepad-body {
            padding: 10px 0;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .icon-pencil-wrapper {
            position: absolute;
            top: 5px;
            right: 0;
            color: #bbb;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 50%;
            z-index: 5;
            pointer-events: none;
        }
        .editor-content {
            flex: 1;
            min-height: 150px;
            border: none;
            outline: none;
            padding: 0 10px;
            font-family: var(--font-hand);
            font-size: 22px;
            color: #555;
            background-image: linear-gradient(transparent 95%, #E0E0E0 95%);
            background-size: 100% 30px;
            line-height: 30px;
            white-space: pre-wrap;
            overflow-y: auto;
            text-align: center;
        }
        .editor-content:empty:before { content: attr(placeholder); color: #ccc; opacity: 0.8; display: block; }

        .action-area {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: center;
        }
        .btn-send {
            width: 100%;
            max-width: 400px;
            height: 56px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark));
            box-shadow: 0 8px 20px rgba(242, 157, 134, 0.4);
            color: white;
            font-family: var(--font-script);
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            text-shadow: 0 2px 2px rgba(0,0,0,0.1);
        }
        .btn-send:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(242, 157, 134, 0.4); }

        /* * 팝업 스타일 디자인 (고급화) */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.show { display: flex; }
        
        .modal-content {
            background: var(--color-bg); /* 아이보리 배경 */
            width: 85%;
            max-width: 340px;
            border-radius: 20px;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            position: relative;
            border: 2px solid #fff;
        }
        .modal-header {
            font-family: var(--font-main);
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text-main);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .modal-close {
            background: #fff;
            border: 1px solid #ddd;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .save-list {
            overflow-y: auto;
            flex: 1;
            max-height: 320px;
            scrollbar-width: thin;
            scrollbar-color: var(--color-ribbon) transparent;
        }
        .save-list::-webkit-scrollbar { width: 6px; }
        .save-list::-webkit-scrollbar-thumb { background-color: var(--color-ribbon); border-radius: 3px; }

        .save-item {
            background: white;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        .save-item:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(242, 157, 134, 0.15);
        }
        
        .save-thumb {
            width: 44px; height: 44px;
            border-radius: 8px;
            object-fit: cover;
            background: #eee;
            flex-shrink: 0;
            border: 1px solid #eee;
        }
        
        .save-info { 
            flex: 1; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
        }
        .save-date { font-size: 10px; color: #aaa; margin-bottom: 3px; font-weight: 500; }
        
        .save-preview-wrapper {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }
        .save-preview {
            font-size: 14px; color: #444; 
            font-weight: 500;
            display: inline-block;
            transition: transform 3s linear;
        }
        .save-item:hover .save-preview {
            transform: translateX(-100%);
            transition-duration: 5s;
        }

        .btn-text-only {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: #f8f8f8;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s;
            flex-shrink: 0;
            font-size: 12px;
            font-weight: bold;
        }
        .btn-text-only:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .empty-msg { text-align: center; color: #aaa; padding: 30px 0; font-size: 14px; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- 헤더 -->
        <header class="top-bar px-20">
            <button class="btn-icon"><i data-lucide="arrow-left"></i></button>
            <h1>Greeting Card Editor</h1>
            <div class="header-actions">
                <button class="btn-icon" onclick="saveCard()" title="저장">
                    <i data-lucide="save" size="20"></i>
                </button>
                <button class="btn-icon" onclick="openLoadModal()" title="불러오기">
                    <i data-lucide="folder-open" size="20"></i>
                </button>
            </div>
        </header>

        <!-- 카드 미리보기 -->
        <section class="card-preview px-20">
            <div class="card-paper">
                <img id="mainCardImg" src="https://images.unsplash.com/photo-1490750967868-58cb75065ed2?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Watercolor Flowers" class="card-img">
                <div class="card-text">
                    <div id="cardTextDisplay">Happy Birthday,<br>dear Emma!<br>With love, Anna.</div>
                </div>
                <div class="card-ribbon">
                    <span id="ribbonTextDisplay">Heart-Connect</span>
                </div>
            </div>
        </section>

        <!-- 템플릿 선택 -->
        <section class="template-selector">
            <div class="thumb-item active">
                <img src="https://images.unsplash.com/photo-1490750967868-58cb75065ed2?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Thinking">
                <span>Thinking</span>
            </div>
            <div class="thumb-item">
                <img src="https://images.unsplash.com/photo-1527638056260-2475e1491753?auto=format&fit=crop&w=600&q=80" alt="Congrats">
                <span>Congrats</span>
            </div>
            <div class="thumb-item">
                <img src="https://images.unsplash.com/photo-1516062423079-7ca13cdc7f5a?auto=format&fit=crop&w=600&q=80" alt="Love">
                <span>Love</span>
            </div>
            <div class="thumb-item">
                <img src="https://images.unsplash.com/photo-1482269557252-4e96816104bc?auto=format&fit=crop&w=600&q=80" alt="Sorry">
                <span>Sorry</span>
            </div>
            <div class="thumb-item">
                <img src="https://images.unsplash.com/photo-1523475200377-f2795e263255?auto=format&fit=crop&w=600&q=80" alt="Thanks">
                <span>Thanks</span>
            </div>
            
            <!-- 직접 입력 -->
            <div class="thumb-item" onclick="triggerFileUpload()">
                <div class="upload-placeholder">
                    <i data-lucide="camera" size="24"></i>
                </div>
                <span>직접 선택</span>
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(this)">
            </div>
        </section>

        <!-- 툴바 (패딩 조정됨, 드래그 스크롤 적용) -->
        <section class="style-toolbar">
            <select id="fontSelect" class="style-select" onchange="applyFontName(this.value)">
                <option value="'Great Vibes', cursive">필기체</option>
                <option value="'Caveat', cursive">손글씨</option>
                <option value="'Roboto', sans-serif">고딕</option>
            </select>
            <select id="fontSizeSelect" class="style-select" onchange="applyFontSize(this.value)">
                <option value="1">16px</option>
                <option value="2">20px</option>
                <option value="3">24px</option>
                <option value="4" selected>32px</option>
                <option value="5">40px</option>
                <option value="6">48px</option>
            </select>

            <div class="toolbar-divider"></div>

            <button class="btn-style" onclick="execCmd('justifyLeft')" title="왼쪽 정렬"><i data-lucide="align-left" size="18"></i></button>
            <button class="btn-style" onclick="execCmd('justifyCenter')" title="가운데 정렬"><i data-lucide="align-center" size="18"></i></button>
            <button class="btn-style" onclick="execCmd('justifyRight')" title="오른쪽 정렬"><i data-lucide="align-right" size="18"></i></button>

            <div class="toolbar-divider"></div>

            <button class="btn-style" onclick="execCmd('bold')" title="굵게"><i data-lucide="bold" size="18"></i></button>
            <button class="btn-style" onclick="execCmd('italic')" title="기울임"><i data-lucide="italic" size="18"></i></button>
            <button class="btn-style" onclick="execCmd('underline')" title="밑줄"><i data-lucide="underline" size="18"></i></button>
            
            <div class="toolbar-divider"></div>

            <button class="btn-style" onclick="toggleColorPanel()" title="글자 색상">
                <div id="colorIndicator" class="color-preview" style="background-color: #222;"></div>
            </button>
        </section>

        <!-- 색상 패널 -->
        <div id="colorPanel" class="color-panel">
            <span style="font-size:12px; color:#666;">색상:</span>
            <input type="color" id="pickerInput" value="#222222" style="border:none; width:30px; height:30px; cursor:pointer;">
            <button class="btn-confirm" onclick="confirmColor()">확인</button>
            <button style="border:none; background:none; font-size:16px; margin-left:10px; cursor:pointer;" onclick="toggleColorPanel()">✕</button>
        </div>

        <div class="px-20" style="margin-bottom: 5px;">
             <input type="text" id="ribbonInput" class="ribbon-input" placeholder="보낸 사람 (리본 텍스트)" value="Heart-Connect">
        </div>

        <!-- 에디터 -->
        <section class="message-input px-20">
            <div class="notepad-container">
                <div class="notepad-top"></div>
                <div class="notepad-body">
                    <div class="icon-pencil-wrapper">
                        <i data-lucide="pencil" size="16"></i>
                    </div>
                    <div id="editor" class="editor-content" contenteditable="true" 
                         placeholder="메시지를 입력하세요...">Happy Birthday,<br>dear Emma!<br>With love, Anna.</div>
                </div>
            </div>

            <div class="action-area">
                <button class="btn-send">Send</button>
            </div>
        </section>

    </div>

    <!-- 불러오기 모달 -->
    <div id="loadModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>나의 카드 보관함</span>
                <button class="modal-close" onclick="closeLoadModal()">✕</button>
            </div>
            <div id="saveList" class="save-list">
                <!-- 리스트 아이템 -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. 드래그 앤 스크롤 (템플릿 셀렉터)
        const slider = document.querySelector('.template-selector');
        let isDown = false, startX, scrollLeft, isDragging = false; 

        slider.addEventListener('mousedown', (e) => {
            isDown = true; isDragging = false;
            slider.classList.add('active'); 
            startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft;
        });
        slider.addEventListener('mouseleave', () => { isDown = false; slider.classList.remove('active'); });
        slider.addEventListener('mouseup', () => { isDown = false; slider.classList.remove('active'); setTimeout(() => isDragging=false, 0); });
        slider.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault(); 
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2; 
            slider.scrollLeft = scrollLeft - walk;
            if (Math.abs(walk) > 5) isDragging = true;
        });

        // 2. 드래그 앤 스크롤 (툴바)
        const toolbar = document.querySelector('.style-toolbar');
        let tIsDown = false, tStartX, tScrollLeft, tIsDragging = false;

        toolbar.addEventListener('mousedown', (e) => {
            tIsDown = true; tIsDragging = false;
            toolbar.classList.add('active'); 
            tStartX = e.pageX - toolbar.offsetLeft; tScrollLeft = toolbar.scrollLeft;
        });
        toolbar.addEventListener('mouseleave', () => { tIsDown = false; toolbar.classList.remove('active'); });
        toolbar.addEventListener('mouseup', () => { tIsDown = false; toolbar.classList.remove('active'); setTimeout(() => tIsDragging=false, 0); });
        toolbar.addEventListener('mousemove', (e) => {
            if (!tIsDown) return;
            e.preventDefault(); 
            const x = e.pageX - toolbar.offsetLeft;
            const walk = (x - tStartX) * 2; 
            toolbar.scrollLeft = tScrollLeft - walk;
            if (Math.abs(walk) > 5) tIsDragging = true;
        });


        // 3. 썸네일 선택 & 직접 업로드
        const thumbs = document.querySelectorAll('.thumb-item:not(:last-child)'); 
        const mainImage = document.getElementById('mainCardImg');
        const fileInput = document.getElementById('fileInput');

        thumbs.forEach(thumb => {
            thumb.addEventListener('click', function() {
                if (isDragging) return;
                setActiveThumb(this);
                const newImgSrc = this.querySelector('img').src;
                updateMainImage(newImgSrc);
            });
        });

        function setActiveThumb(target) {
            document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active'));
            target.classList.add('active');
        }

        function updateMainImage(src) {
            mainImage.style.opacity = '0.5';
            setTimeout(() => {
                mainImage.src = src;
                mainImage.style.opacity = '1';
            }, 150);
        }

        window.triggerFileUpload = function() { if (isDragging) return; fileInput.click(); };
        window.handleFileUpload = function(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateMainImage(e.target.result);
                    setActiveThumb(input.parentElement);
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        // 4. 에디터 로직
        const editor = document.getElementById('editor');
        const cardTextDisplay = document.getElementById('cardTextDisplay');
        const ribbonInput = document.getElementById('ribbonInput');
        const ribbonTextDisplay = document.getElementById('ribbonTextDisplay');
        
        function syncText() { cardTextDisplay.innerHTML = editor.innerHTML; }
        editor.addEventListener('input', syncText);
        ribbonInput.addEventListener('input', (e) => { ribbonTextDisplay.innerText = e.target.value; });

        window.execCmd = function(cmd, val=null) { if(tIsDragging) return; document.execCommand(cmd, false, val); editor.focus(); syncText(); };
        window.applyFontName = function(val) { if(tIsDragging) return; document.execCommand('styleWithCSS', false, true); document.execCommand('fontName', false, val); document.execCommand('styleWithCSS', false, false); editor.focus(); syncText(); };
        window.applyFontSize = function(val) { if(tIsDragging) return; document.execCommand('fontSize', false, val); editor.focus(); syncText(); };

        // 5. 색상 변경
        const colorPanel = document.getElementById('colorPanel');
        const pickerInput = document.getElementById('pickerInput');
        const colorIndicator = document.getElementById('colorIndicator');
        let savedRange = null;

        window.toggleColorPanel = function() {
            if(tIsDragging) return;
            const sel = window.getSelection();
            if (sel.rangeCount > 0) savedRange = sel.getRangeAt(0);
            const isShow = colorPanel.classList.contains('show');
            isShow ? colorPanel.classList.remove('show') : colorPanel.classList.add('show');
        };

        pickerInput.addEventListener('input', (e) => { colorIndicator.style.backgroundColor = e.target.value; });

        window.confirmColor = function() {
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
            document.execCommand('foreColor', false, pickerInput.value);
            colorPanel.classList.remove('show');
            syncText();
        };

        // 6. 저장 및 불러오기
        const STORAGE_KEY = 'my_greeting_cards_v2';

        window.saveCard = function() {
            const data = {
                id: Date.now(),
                date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                html: editor.innerHTML,
                ribbon: ribbonInput.value,
                imgSrc: mainImage.src
            };
            
            let list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            list.unshift(data); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
            alert('카드가 저장되었습니다!');
        };

        const loadModal = document.getElementById('loadModal');
        const saveListEl = document.getElementById('saveList');

        window.openLoadModal = function() {
            loadModal.classList.add('show');
            renderSaveList();
        };

        window.closeLoadModal = function() {
            loadModal.classList.remove('show');
        };

        function renderSaveList() {
            const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            saveListEl.innerHTML = '';

            if (list.length === 0) {
                saveListEl.innerHTML = '<div class="empty-msg">저장된 카드가 없습니다.<br>새로운 카드를 만들어보세요!</div>';
                return;
            }

            list.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'save-item';
                
                const plainText = item.html.replace(/<[^>]*>/g, ' ').substring(0, 50);
                
                div.innerHTML = `
                    <div class="save-info" onclick="loadCardItem(${index})">
                        <div class="save-date">${item.date}</div>
                        <div class="save-preview-wrapper">
                            <span class="save-preview">${plainText || '(내용 없음)'}</span>
                        </div>
                    </div>
                    
                    <button class="btn-text-only" title="글씨만 가져오기" onclick="loadTextOnly(${index}, event)">T</button>
                    
                    <img src="${item.imgSrc}" class="save-thumb" onclick="loadCardItem(${index})">
                `;
                saveListEl.appendChild(div);
            });
        }

        window.loadCardItem = function(index) {
            const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const item = list[index];
            if (!item) return;

            editor.innerHTML = item.html;
            ribbonInput.value = item.ribbon || '';
            if (item.imgSrc) mainImage.src = item.imgSrc;
            
            ribbonTextDisplay.innerText = ribbonInput.value;
            syncText();
            closeLoadModal();
        };

        window.loadTextOnly = function(index, event) {
            event.stopPropagation(); 
            const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const item = list[index];
            if (!item) return;

            editor.innerHTML = item.html;
            ribbonInput.value = item.ribbon || '';
            
            ribbonTextDisplay.innerText = ribbonInput.value;
            syncText();
            closeLoadModal();
            alert('글씨 내용만 불러왔습니다.');
        };

        syncText();

    </script>
</body>
</html>